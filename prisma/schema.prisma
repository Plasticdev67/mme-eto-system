generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// USERS & AUTH
// ============================================================

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  passwordHash  String
  role          UserRole  @default(VIEWER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  coordinatedProjects  Project[]  @relation("ProjectCoordinator")
  managedProjects      Project[]  @relation("ProjectManager")
  installManagedProjects Project[] @relation("InstallManager")
  coordinatedProducts  Product[]  @relation("ProductCoordinator")
  designedProducts     Product[]  @relation("ProductDesigner")
  createdQuotes        Quote[]    @relation("QuoteCreator")

  @@map("users")
}

enum UserRole {
  ADMIN
  ESTIMATOR
  PROJECT_COORDINATOR
  DESIGNER
  PRODUCTION_MANAGER
  VIEWER
}

// ============================================================
// CUSTOMERS
// ============================================================

model Customer {
  id            String       @id @default(cuid())
  name          String
  customerType  CustomerType @default(OTHER)
  address       String?
  phone         String?
  email         String?
  paymentTerms  String?
  notes         String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  contacts  CustomerContact[]
  projects  Project[]
  quotes    Quote[]

  @@map("customers")
}

enum CustomerType {
  MAIN_CONTRACTOR
  UTILITY
  COUNCIL
  DIRECT
  DEFENCE
  OTHER
}

model CustomerContact {
  id         String   @id @default(cuid())
  customerId String
  name       String
  role       String?
  phone      String?
  email      String?
  isPrimary  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("customer_contacts")
}

// ============================================================
// SUPPLIERS
// ============================================================

model Supplier {
  id              String   @id @default(cuid())
  name            String
  address         String?
  phone           String?
  email           String?
  whatTheySupply  String?
  paymentTerms    String?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  contacts       SupplierContact[]
  purchaseOrders PurchaseOrder[]
  plantHires     PlantHire[]
  subContracts   SubContractorWork[]

  @@map("suppliers")
}

model SupplierContact {
  id         String   @id @default(cuid())
  supplierId String
  name       String
  role       String?
  phone      String?
  email      String?
  isPrimary  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  supplier Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@map("supplier_contacts")
}

// ============================================================
// PROJECTS (Central Hub)
// ============================================================

model Project {
  id              String   @id @default(cuid())
  projectNumber   String   @unique
  name            String
  customerId      String?
  coordinatorId   String?
  projectManagerId  String?
  installManagerId  String?

  projectType     ProjectType     @default(STANDARD)
  workStream      WorkStream      @default(ADHOC)
  salesStage      SalesStage      @default(OPPORTUNITY)
  projectStatus   ProjectStatus   @default(OPPORTUNITY)
  contractType    ContractType    @default(STANDARD)

  // Lifecycle gates (P0-P5)
  lifecycleStage  LifecycleStage @default(P0)
  p0Date          DateTime?
  p1Date          DateTime?
  p2Date          DateTime?
  p3Date          DateTime?
  p4Date          DateTime?
  p5Date          DateTime?

  // Sprint 2: Board / Kanban fields
  priority        ProjectPriority        @default(NORMAL)
  isICUFlag       Boolean                @default(false)
  classification  ProjectClassification  @default(NORMAL)
  ragStatus       RagStatus?
  projectSubStatus String?

  // Financial values
  estimatedValue  Decimal? @db.Decimal(12, 2)
  contractValue   Decimal? @db.Decimal(12, 2)
  currentCost     Decimal? @db.Decimal(12, 2)
  ncrCost         Decimal? @db.Decimal(12, 2)

  // Location / delivery
  siteLocation    String?
  deliveryType    String?
  projectRegion   String?
  notes           String?

  // Key dates
  enquiryReceived   DateTime?
  quoteSubmitted    DateTime?
  orderReceived     DateTime?
  targetCompletion  DateTime?
  actualCompletion  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  customer        Customer?       @relation(fields: [customerId], references: [id])
  coordinator     User?           @relation("ProjectCoordinator", fields: [coordinatorId], references: [id])
  projectManager  User?           @relation("ProjectManager", fields: [projectManagerId], references: [id])
  installManager  User?           @relation("InstallManager", fields: [installManagerId], references: [id])
  products        Product[]
  quotes          Quote[]
  purchaseOrders  PurchaseOrder[]
  documents       Document[]
  ncrs            NonConformanceReport[]
  retentions      RetentionHoldback[]
  plantHires      PlantHire[]
  subContracts    SubContractorWork[]
  costCategories  ProjectCostCategory[]

  @@map("projects")
}

enum ProjectType {
  STANDARD
  BESPOKE_MAJOR
}

enum WorkStream {
  COMMUNITY
  UTILITIES
  BESPOKE
  BLAST
  BUND_CONTAINMENT
  REFURBISHMENT
  ADHOC
}

enum SalesStage {
  OPPORTUNITY
  QUOTED
  ORDER
}

enum ProjectStatus {
  OPPORTUNITY
  QUOTATION
  DESIGN
  MANUFACTURE
  INSTALLATION
  REVIEW
  COMPLETE
}

enum ContractType {
  NEC
  STANDARD
  FRAMEWORK_CALLOFF
  OTHER
}

enum ProjectPriority {
  NORMAL
  HIGH
  CRITICAL
}

enum ProjectClassification {
  NORMAL
  MEGA
  SUB_CONTRACT
}

enum RagStatus {
  GREEN
  AMBER
  RED
}

enum LifecycleStage {
  P0 // Enquiry
  P1 // Quotation
  P2 // Order Handover
  P3 // Design Review
  P4 // Production Complete
  P5 // Handover / Close
}

// ============================================================
// NON-CONFORMANCE REPORTS (NCRs)
// ============================================================

model NonConformanceReport {
  id           String      @id @default(cuid())
  ncrNumber    String      @unique
  projectId    String
  productId    String?
  title        String
  description  String?
  severity     NcrSeverity @default(MINOR)
  status       NcrStatus   @default(OPEN)
  costImpact   Decimal?    @db.Decimal(12, 2)
  raisedDate   DateTime    @default(now())
  closedDate   DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  project Product? @relation("NcrProduct", fields: [productId], references: [id])
  parentProject Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("non_conformance_reports")
}

enum NcrSeverity {
  MINOR
  MAJOR
  CRITICAL
}

enum NcrStatus {
  OPEN
  INVESTIGATING
  RESOLVED
  CLOSED
}

// ============================================================
// PRODUCT CATALOGUE (Reference data)
// ============================================================

model ProductCatalogue {
  id           String  @id @default(cuid())
  partCode     String  @unique
  description  String
  classId      String  @default("PROD")
  active       Boolean @default(true)

  // Guide pricing (pre-fill when quoting)
  guideUnitCost      Decimal? @db.Decimal(12, 2)
  guideMarginPercent Decimal? @db.Decimal(5, 2)
  defaultUnits       String?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Products using this catalogue entry
  products   Product[]
  quoteLines QuoteLine[]

  @@map("product_catalogue")
}

// ============================================================
// PRODUCTS (Line items within a project - THE TRACKER)
// ============================================================

model Product {
  id                String  @id @default(cuid())
  projectId         String
  catalogueItemId   String?
  partCode          String
  description       String
  additionalDetails String?
  quantity          Int     @default(1)
  productJobNumber  String?

  // Assignment
  allocatedDesignerId String?
  coordinatorId       String?

  // Current status tracking (maps to Excel tracker columns)
  currentDepartment       Department       @default(PLANNING)
  currentOperationalStatus String?
  progressMonitor         String?

  // Appraisal stage
  appraisalTargetDate     DateTime?
  appraisalFinishDate     DateTime?
  appraisalStatus         String?

  // Drawing
  drawingNumber           String?

  // Design stage
  designPlannedStart      DateTime?
  designTargetDate        DateTime?
  designCompletionDate    DateTime?
  designStatus            String?

  // Production stage
  productionPlannedStart  DateTime?
  productionTargetDate    DateTime?
  productionCompletionDate DateTime?
  productionStatus        ProductionStage?

  // Installation stage
  installPlannedStart     DateTime?
  installTargetDate       DateTime?
  installCompletionDate   DateTime?
  installStatus           String?

  // Review
  asBuiltComplete         Boolean  @default(false)
  reviewCompletedDate     DateTime?

  // Required completion
  requiredCompletionDate  DateTime?

  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  project       Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  catalogueItem ProductCatalogue? @relation(fields: [catalogueItemId], references: [id])
  designer      User?            @relation("ProductDesigner", fields: [allocatedDesignerId], references: [id])
  coordinator   User?            @relation("ProductCoordinator", fields: [coordinatorId], references: [id])
  quoteLines    QuoteLine[]
  poLines       PurchaseOrderLine[]
  documents     Document[]
  ncrs          NonConformanceReport[] @relation("NcrProduct")
  subContracts  SubContractorWork[]

  @@map("products")
}

enum Department {
  PLANNING
  DESIGN
  PRODUCTION
  INSTALLATION
  REVIEW
  COMPLETE
}

enum ProductionStage {
  AWAITING
  CUTTING
  FABRICATION
  FITTING
  SHOTBLASTING
  PAINTING
  PACKING
  DISPATCHED
  STORAGE
  REWORK
  SUB_CONTRACT
  COMPLETED
  N_A
}

// ============================================================
// QUOTES
// ============================================================

model Quote {
  id              String      @id @default(cuid())
  customerId      String
  projectId       String?
  quoteNumber     String      @unique
  revisionNumber  Int         @default(1)
  status          QuoteStatus @default(DRAFT)
  subject         String?
  dateCreated     DateTime    @default(now())
  dateSubmitted   DateTime?
  validUntil      DateTime?
  totalCost       Decimal?    @db.Decimal(12, 2)
  totalSell       Decimal?    @db.Decimal(12, 2)
  overallMargin   Decimal?    @db.Decimal(5, 2)
  notes           String?
  createdById     String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  customer   Customer    @relation(fields: [customerId], references: [id])
  project    Project?    @relation(fields: [projectId], references: [id], onDelete: SetNull)
  createdBy  User?       @relation("QuoteCreator", fields: [createdById], references: [id])
  quoteLines QuoteLine[]

  @@map("quotes")
}

enum QuoteStatus {
  DRAFT
  SUBMITTED
  ACCEPTED
  DECLINED
  REVISED
}

model QuoteLine {
  id              String  @id @default(cuid())
  quoteId         String
  productId       String?
  catalogueItemId String?
  description     String
  dimensions      String?
  quantity        Int     @default(1)
  units           String?

  // Pricing
  unitCost       Decimal? @db.Decimal(12, 2)
  costTotal      Decimal? @db.Decimal(12, 2)
  marginPercent  Decimal? @db.Decimal(5, 2)
  sellPrice      Decimal? @db.Decimal(12, 2)

  // Flags
  isOptional      Boolean @default(false)
  sortOrder       Int     @default(0)
  marginOverride  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  quote         Quote             @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  product       Product?          @relation(fields: [productId], references: [id])
  catalogueItem ProductCatalogue? @relation(fields: [catalogueItemId], references: [id])

  @@map("quote_lines")
}

// ============================================================
// PURCHASE ORDERS
// ============================================================

model PurchaseOrder {
  id               String   @id @default(cuid())
  poNumber         String   @unique
  projectId        String
  supplierId       String?
  status           POStatus @default(DRAFT)
  dateRaised       DateTime @default(now())
  dateSent         DateTime?
  expectedDelivery DateTime?
  totalValue       Decimal? @db.Decimal(12, 2)
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  project  Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  supplier Supplier?          @relation(fields: [supplierId], references: [id])
  poLines  PurchaseOrderLine[]

  @@map("purchase_orders")
}

enum POStatus {
  DRAFT
  SENT
  PARTIALLY_RECEIVED
  COMPLETE
  CANCELLED
}

model PurchaseOrderLine {
  id          String  @id @default(cuid())
  poId        String
  productId   String?
  description String
  quantity    Int     @default(1)
  unitCost    Decimal? @db.Decimal(12, 2)
  totalCost   Decimal? @db.Decimal(12, 2)
  received    Boolean @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  purchaseOrder PurchaseOrder @relation(fields: [poId], references: [id], onDelete: Cascade)
  product       Product?      @relation(fields: [productId], references: [id])

  @@map("purchase_order_lines")
}

// ============================================================
// DOCUMENTS
// ============================================================

model Document {
  id            String       @id @default(cuid())
  projectId     String
  productId     String?
  filename      String
  filePath      String
  fileSize      Int?
  documentType  DocumentType @default(OTHER)
  description   String?
  uploadedBy    String?
  uploadedAt    DateTime     @default(now())

  // Relations
  project Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])

  @@map("documents")
}

enum DocumentType {
  DRAWING
  SPECIFICATION
  CERTIFICATE
  TEST_REPORT
  PHOTO
  CORRESPONDENCE
  OTHER
}

// ============================================================
// RETENTION HOLDBACKS
// ============================================================

model RetentionHoldback {
  id                String          @id @default(cuid())
  projectId         String
  retentionPercent  Decimal?        @db.Decimal(5, 2)
  retentionAmount   Decimal?        @db.Decimal(12, 2)
  releaseDate       DateTime?
  status            RetentionStatus @default(HELD)
  notes             String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("retention_holdbacks")
}

enum RetentionStatus {
  HELD
  PARTIALLY_RELEASED
  RELEASED
}

// ============================================================
// PLANT HIRE
// ============================================================

model PlantHire {
  id          String          @id @default(cuid())
  projectId   String
  supplierId  String?
  description String
  hireStart   DateTime?
  hireEnd     DateTime?
  weeklyRate  Decimal?        @db.Decimal(12, 2)
  totalCost   Decimal?        @db.Decimal(12, 2)
  status      PlantHireStatus @default(ON_HIRE)
  notes       String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  project  Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  supplier Supplier? @relation(fields: [supplierId], references: [id])

  @@map("plant_hires")
}

enum PlantHireStatus {
  ON_HIRE
  OFF_HIRE
  RETURNED
}

// ============================================================
// SUB-CONTRACTOR WORK
// ============================================================

model SubContractorWork {
  id            String             @id @default(cuid())
  projectId     String
  supplierId    String?
  productId     String?
  description   String
  agreedValue   Decimal?           @db.Decimal(12, 2)
  invoicedToDate Decimal?          @db.Decimal(12, 2)
  status        SubContractStatus  @default(IN_PROGRESS)
  notes         String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  project  Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  supplier Supplier? @relation(fields: [supplierId], references: [id])
  product  Product?  @relation(fields: [productId], references: [id])

  @@map("sub_contractor_works")
}

enum SubContractStatus {
  PENDING
  IN_PROGRESS
  COMPLETE
  DISPUTED
}

// ============================================================
// PROJECT COST CATEGORIES (Sage integration)
// ============================================================

model ProjectCostCategory {
  id            String  @id @default(cuid())
  projectId     String
  costCode      String
  description   String
  budgetAmount  Decimal? @db.Decimal(12, 2)
  actualAmount  Decimal? @db.Decimal(12, 2)
  committedAmount Decimal? @db.Decimal(12, 2)
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, costCode])
  @@map("project_cost_categories")
}
